#!/usr/bin/env bash
#    ucaresystem - All-in-one system update and maintenance tool
#    Copyright:
#       2009 Salih Emin <salih@utappia.org>
#       2020 Ioannis Tsagatakis <tsagatakis@protonmail.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

# lib_dir will change to point at /usr/lib/ucaresystem during packaging
lib_dir=$(dirname "$0")
# shellcheck source=config
source "${lib_dir}/config"
trap trap_handler 1 2 3 6

function dummy_runner() {
  "$@"
  return $?
}

DEFINE_string 'runner' "cli" 'Specify which version (cli,gui)'

# parse the command-line
setup_common_flags
FLAGS "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

common_cmd_options
load_config_file

declare -A use_runners
declare -A use_dispatch

use_runners=([cli]="dummy_runner" [gui]="${X_SUDO_RUNNER}" [xterm]="${X_SUDO_RUNNER}")
use_dispatch=([cli]="cli" [gui]="xterm" [xterm]="xterm")

runner=${use_runners[${FLAGS_runner}]}
if [[ -z $runner ]]; then
  echo "${RED}Error${NORMAL}: Bad runner option '${FLAGS_runner}'."
  exit 2
fi

dispatch=${use_dispatch[${FLAGS_runner}]}
executable="${lib_dir}/ucaresystem-${dispatch}"

"$runner" "$executable" "$*"
exit $?
